<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="simple.css" />
    <script src="papaparse.min.js"></script>
    <title>DataMerge</title>
  </head>
  <body>
    <main>
      <h1>DataMerge</h1>
      <p>
        Use the button below to upload the folder containing your statistics.
      </p>
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <input
          id="fileUpload"
          name="fileUpload"
          type="file"
          webkitdirectory
          directory
          multiple
        />
        <label for="fileUpload" id="progress"></label>
      </div>
    </main>
    <div class="notice">
      <h4 style="margin: 0 0 0.5rem 0">FAQ</h4>
      <details open>
        <summary>
          <b>Q: Which folder do I upload?</b>
        </summary>
        <p>A: Upload the top level folder containing all the statistics.</p>
        <ul>
          <li>
            ğŸ“ MyFolder <u><b>â¬… Upload this</b></u>
          </li>
          <ul>
            <li>ğŸ“ Alpha_1_Statistics</li>
            <ul>
              <li>ğŸ“„ file1.csv</li>
              <li>ğŸ“„ file2.csv</li>
            </ul>
            <li>ğŸ“ Alpha_2_Statistics</li>
            <ul>
              <li>ğŸ“„ file1.csv</li>
              <li>ğŸ“„ file2.csv</li>
            </ul>
            <li>ğŸ“ Beta_1_Statistics</li>
            <ul>
              <li>ğŸ“„ file1.csv</li>
              <li>ğŸ“„ file2.csv</li>
            </ul>
          </ul>
        </ul>
      </details>
    </div>
    <script>
      const combinedData = new Map();
      let maxLength = 0;

      function onFileParse(results, file) {
        // Get the path
        const path = file.webkitRelativePath;
        const fileName = path.split("/").at(-1);

        // Parse a key from the filename for aggregation
        const key = fileName.replace(/_\d+_/g, "_").replace(".csv", "");

        if (!combinedData.has(key)) {
          combinedData.set(key, []);
        }

        // Skip the headers
        const data = results.data.slice(4);

        for (const row of data) {
          row[0] && combinedData.get(key).push([row[0]]);
          maxLength = Math.max(maxLength, combinedData.get(key).length);
        }
      }

      function setMessage(message) {
        document.getElementById("progress").textContent = message;
      }

      document
        .getElementById("fileUpload")
        .addEventListener("change", async (event) => {
          const files = event.target.files;
          const csvFiles = Array.from(files).filter(
            (f) => f.type === "text/csv" && !f.name.includes("Overall")
          );
          const totalFiles = csvFiles.length;

          if (!totalFiles) {
            alert("No CSV files found.");
            return;
          }

          setMessage("Parsingâ€¦");
          let completedFiles = 0;

          const parsePromises = csvFiles.map((file) => {
            return new Promise((resolve, reject) => {
              Papa.parse(file, {
                complete: async (results) => {
                  onFileParse(results, file);

                  setMessage(`Parsed ${++completedFiles}/${totalFiles} files`);

                  resolve(results);
                },
                error: (error) => {
                  reject(error);
                },
              });
            });
          });

          try {
            await Promise.all(parsePromises);

            const csvData = [];

            for (let i = 0; i < maxLength; i++) {
              const row = {};

              for (const [key, values] of combinedData.entries()) {
                values[i] && (row[key] = values[i]);
              }

              csvData.push(row);
            }

            const csv = Papa.unparse(csvData);

            const blob = new Blob([csv], {
              type: "text/csv;charset=utf-8;",
            });

            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = `merged_data_${new Date().toISOString()}.csv`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(url);

            setMessage("Files parsed successfully âœ“  ");
          } catch (error) {
            alert("Error parsing files");

            console.error(error);
          }
        });
    </script>
  </body>
</html>
